// This file was generated by typhen-api

package battle

import (
	"app/typhenapi/core"
	submarine_battle "app/typhenapi/type/submarine/battle"
)

const (
	MessageType_Ping int32 = -973977363
)

// WebSocketAPI sends messages, and dispatches message events.
type WebSocketAPI struct {
	session      typhenapi.Session
	serializer   *typhenapi.Serializer
	errorHandler func([]byte, error)

	Ping func(message *submarine_battle.Ping)
}

// New creates a WebSocketAPI.
func New(session typhenapi.Session, serializer *typhenapi.Serializer, errorHandler func([]byte, error)) *WebSocketAPI {
	api := &WebSocketAPI{}
	api.session = session
	api.serializer = serializer
	api.errorHandler = errorHandler
	return api
}

// SendPing sends a ping message.
func (api *WebSocketAPI) SendPing(ping *submarine_battle.Ping) {
	message, err := typhenapi.NewMessage(api.serializer, MessageType_Ping, ping)

	if err != nil {
		api.errorHandler(nil, err)
		return
	}

	api.session.Send(message.Bytes())
}

// DispatchMessageEvent dispatches a binary message.
func (api *WebSocketAPI) DispatchMessageEvent(data []byte) {

	message, err := typhenapi.NewMessageFromBytes(data)

	if err != nil {
		api.errorHandler(data, err)
		return
	}

	switch message.Type {
	case MessageType_Ping:
		typhenType := new(submarine_battle.Ping)
		if err := api.serializer.Deserialize(message.Body, typhenType); err != nil {
			api.errorHandler(data, err)
			return
		}

		if err := typhenType.Coerce(); err != nil {
			api.errorHandler(data, err)
			return
		}

		if api.Ping != nil {
			api.Ping(typhenType)
		}
	}
}
