// This file was generated by typhen-api

using System;

namespace TyphenApi.WebSocketApi{{#if namespace}}.Parts.{{upperCamelCase namespace}}{{/if}}
{
    public partial class {{upperCamelCase name}} : TyphenApi.IWebSocketApi
    {
        {{#if variables}}
        public enum MessageType
        {
            {{#each variables}}
            {{upperCamelCase name}} = {{webSocketMessageType this}},
            {{/each}}
        }
        {{/if}}

        {{#if variables}}
        readonly IWebSocketSession session;
        {{/if}}

        {{#each variables}}
        public event Action<{{{typeName type}}}> On{{upperCamelCase name}}Receive;
        {{/each}}

        {{#each modules}}
        {{#if variables}}
        public TyphenApi.WebSocketApi.Parts.{{upperCamelCase fullName}} {{upperCamelCase name}} { get; private set; }
        {{/if}}
        {{/each}}

        public {{upperCamelCase name}}(IWebSocketSession session)
        {
            {{#if variables}}
            this.session = session;
            {{/if}}

            {{#each modules}}
            {{#if variables}}
            {{upperCamelCase name}} = new TyphenApi.WebSocketApi.Parts.{{upperCamelCase fullName}}(session);
            {{/if}}
            {{/each}}
        }

        {{#each variables}}
        public void Send{{upperCamelCase name}}({{{typeName type}}} {{lowerCamelCase name}})
        {
            session.Send((int)MessageType.{{upperCamelCase name}}, {{lowerCamelCase name}});
        }

        public void Send{{upperCamelCase name}}({{#each type.properties}}{{{typeName type}}} {{lowerCamelCase name}}{{#unless @last}}, {{/unless}}{{/each}})
        {
            session.Send((int)MessageType.{{upperCamelCase name}}, new {{{typeName type}}}()
            {
                {{#each type.properties}}
                {{upperCamelCase name}} = {{lowerCamelCase name}},
                {{/each}}
            });
        }
        {{/each}}

        public TyphenApi.TypeBase DispatchMessageEvent(int messageType, byte[] messageData)
        {
            {{#if variables}}
            switch ((MessageType)messageType)
            {
                {{#each variables}}
                case MessageType.{{upperCamelCase name}}:
                {
                    var message = session.MessageDeserializer.Deserialize<{{{typeName type}}}>(messageData);

                    if (On{{upperCamelCase name}}Receive != null)
                    {
                        On{{upperCamelCase name}}Receive(message);
                    }

                    return message;
                }
                {{/each}}
            }
            {{/if}}

            {{#each modules}}
            {{#if @first}}
            TyphenApi.TypeBase message;
            {{/if}}

            {{#if variables}}
            message = {{upperCamelCase name}}.DispatchMessageEvent(messageType, messageData);
            if (message != null)
            {
                return message;
            }
            {{/if}}
            {{/each}}

            return null;
        }
    }
}
